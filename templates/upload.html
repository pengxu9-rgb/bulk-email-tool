<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <title>批量邮件发送工具</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
      body { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; margin: 2rem; }
      .container { max-width: 720px; margin: 0 auto; }
      label { display: block; margin-top: 1rem; font-weight: 600; }
      input[type="text"], select, textarea { width: 100%; padding: 0.5rem; margin-top: 0.25rem; box-sizing: border-box; }
      textarea { min-height: 160px; }
      .btn { margin-top: 1.5rem; padding: 0.6rem 1.2rem; background-color: #2563eb; color: #fff; border: none; border-radius: 4px; cursor: pointer; }
      .btn:hover { background-color: #1d4ed8; }
      .messages { margin-bottom: 1rem; }
      .msg { padding: 0.5rem 0.75rem; border-radius: 4px; margin-bottom: 0.5rem; }
      .msg.error { background-color: #fee2e2; color: #b91c1c; }
      .msg.info { background-color: #dbeafe; color: #1d4ed8; }
      .help { font-size: 0.875rem; color: #4b5563; }
      .card { border: 1px solid #e5e7eb; border-radius: 6px; padding: 1rem 1.25rem; margin-top: 1.5rem; background-color: #f9fafb; }
      code { background-color: #e5e7eb; padding: 0 0.25rem; border-radius: 3px; }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>批量邮件发送工具</h1>
      <p>上传 CSV，选择发件账号（Gmail / 飞书邮箱），按模板批量发送邮件。</p>

      <div class="messages">
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="msg {{ category }}">{{ message }}</div>
            {% endfor %}
          {% endif %}
        {% endwith %}
      </div>

      <form action="{{ url_for('send') }}" method="post" enctype="multipart/form-data">
        <label for="account">发件账号</label>
        <select id="account" name="account">
          {% for acc in accounts %}
            <option value="{{ acc }}">{{ acc|capitalize }}</option>
          {% endfor %}
        </select>
        <div class="help">
          后端通过环境变量配置账号信息，例如：<code>GMAIL_SMTP_USER</code> / <code>FEISHU_SMTP_USER</code>。
        </div>

        <label for="subject">邮件标题</label>
        <input id="subject" name="subject" type="text" required placeholder="例如：关于本次活动的通知">

        <label for="body_template">邮件正文模板</label>
        <textarea id="body_template" name="body_template" placeholder="例如：&#10;Hi $name,&#10;&#10;这是一次测试邮件。&#10;&#10;谢谢！"></textarea>
        <div class="help">
          - 可使用占位符：<code>$name</code>、<code>$email</code> 以及 CSV 里其它列名（如 <code>$company</code>）。<br>
          - 如果 CSV 里有 <code>body</code> 列，将优先使用该列的内容，不再套用模板。
        </div>

        <label for="file">收件人 CSV 文件</label>
        <input id="file" name="file" type="file" accept=".csv" required>
        <div class="help">
          推荐 CSV 列：<code>email</code>（必需）、<code>name</code>（可选）、<code>subject</code>（可选）、<code>body</code>（可选）。<br>
          例如：<br>
          <code>email,name</code><br>
          <code>user1@example.com,Alice</code><br>
          <code>user2@example.com,Bob</code>
        </div>

        <button class="btn" type="submit">开始发送</button>
      </form>

      <div class="card">
        <h2>使用说明（给同事）</h2>
        <ol>
          <li>管理员在服务器上配置环境变量（Gmail / 飞书邮箱账号和密码）。</li>
          <li>同事在浏览器打开该网页，选择账号，上传自己的 CSV，即可批量发信。</li>
          <li>注意控制发送频率，确保收件人均为有授权的用户，避免被判定为垃圾邮件。</li>
        </ol>
      </div>
    </div>
  </body>
  </html>

