<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <title>批量邮件发送工具</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
      body { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; margin: 2rem; }
      .container { max-width: 720px; margin: 0 auto; }
      label { display: block; margin-top: 1rem; font-weight: 600; }
      input[type="text"], select, textarea { width: 100%; padding: 0.5rem; margin-top: 0.25rem; box-sizing: border-box; }
      textarea { min-height: 160px; }
      .btn { margin-top: 1.5rem; padding: 0.6rem 1.2rem; background-color: #2563eb; color: #fff; border: none; border-radius: 4px; cursor: pointer; }
      .btn:hover { background-color: #1d4ed8; }
      .messages { margin-bottom: 1rem; }
      .msg { padding: 0.5rem 0.75rem; border-radius: 4px; margin-bottom: 0.5rem; }
      .msg.error { background-color: #fee2e2; color: #b91c1c; }
      .msg.info { background-color: #dbeafe; color: #1d4ed8; }
      .help { font-size: 0.875rem; color: #4b5563; }
      .card { border: 1px solid #e5e7eb; border-radius: 6px; padding: 1rem 1.25rem; margin-top: 1.5rem; background-color: #f9fafb; }
      code { background-color: #e5e7eb; padding: 0 0.25rem; border-radius: 3px; }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>批量邮件发送工具</h1>
      <p>上传 CSV，选择发件账号（Gmail / 飞书邮箱），按模板批量发送邮件。</p>

      <div class="messages">
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="msg {{ category }}">{{ message }}</div>
            {% endfor %}
          {% endif %}
        {% endwith %}
      </div>

      <form action="{{ url_for('send') }}" method="post" enctype="multipart/form-data">
        <label for="account">发件邮箱类型</label>
        <select id="account" name="account">
          {% for acc in accounts %}
            <option value="{{ acc }}">{{ acc|capitalize }}</option>
          {% endfor %}
        </select>
        <div class="help">
          这里选择的是邮箱服务类型（Gmail / 飞书邮箱），下面可以填写具体邮箱账号和密码。
        </div>

        <label for="smtp_user">发件邮箱地址</label>
        <input id="smtp_user" name="smtp_user" type="text" placeholder="例如：yourname@gmail.com 或 yourname@feishu.cn">
        <div class="help">
          - 如果填写，则优先使用这里的邮箱账号发送；<br>
          - 如果留空，则使用运维在服务器上配置的环境变量账号（<code>GMAIL_SMTP_USER</code> / <code>FEISHU_SMTP_USER</code>）。
        </div>

        <label for="smtp_password">邮箱密码 / 应用专用密码</label>
        <input id="smtp_password" name="smtp_password" type="password" autocomplete="off" placeholder="仅本次发送使用，不会存储">
        <div class="help">
          - Gmail 建议使用“应用专用密码”；<br>
          - 飞书邮箱可使用邮箱密码或专用授权码；<br>
          - 服务器只在本次请求内使用，不会保存到数据库（请确保访问地址是 HTTPS）。
        </div>

        <label for="subject">邮件标题模板</label>
        <input id="subject" name="subject" type="text" placeholder="例如：关于 $name 的活动通知">
        <div class="help">
          - 如果你想完全由 CSV 决定每个人不同的标题，可以在 CSV 里为每行填写 <code>subject</code> 列，并把这里留空；<br>
          - 也可以使用占位符（与正文模板类似）：<code>$name</code>、<code>$email</code>、以及 CSV 里的其它列（如 <code>$company</code>），由模板生成个性化标题。
        </div>

        <label for="body_template">邮件正文模板</label>
        <textarea id="body_template" name="body_template" placeholder="例如：&#10;Hi $name,&#10;&#10;这是一次测试邮件。&#10;&#10;谢谢！"></textarea>
        <div class="help">
          - 可使用占位符：<code>$name</code>、<code>$email</code> 以及 CSV 里其它列名（如 <code>$company</code>）。<br>
          - 如果 CSV 里有 <code>body</code> 列，将优先使用该列的内容，不再套用模板。
        </div>

        <label for="file">收件人 CSV 文件</label>
        <input id="file" name="file" type="file" accept=".csv" required>
        <div class="help">
          推荐 CSV 列：<code>email</code>（必需）、<code>name</code>（可选）、<code>subject</code>（可选）、<code>body</code>（可选）、以及你需要在模板里使用的其它字段（如 <code>company</code>）。<br>
          - 如果你希望每个收件人的标题和正文都完全不同，建议至少包含 <code>subject</code> 和 <code>body</code> 列，并在上方标题 / 正文模板中留空。<br>
          - 示例（每个人完全不同的标题和正文）：<br>
          <code>email,name,subject,body</code><br>
          <code>user1@example.com,Alice,Welcome Alice,"Dear Alice, this is your email."</code><br>
          <code>user2@example.com,Bob,Special for Bob,"Dear Bob, this is a totally different email."</code><br>
          你也可以直接下载一个示例 CSV 文件：<a href="{{ url_for('static', filename='sample.csv') }}">sample.csv</a>
        </div>

        <button class="btn" type="submit">开始发送</button>
      </form>

      <div class="card">
        <h2>使用说明（给同事）</h2>
        <ol>
          <li>同事在浏览器打开该网页，选择邮箱类型（Gmail / 飞书邮箱）。</li>
          <li>在页面上填写自己的发件邮箱地址和密码 / 应用专用密码（仅本次发送使用）。</li>
          <li>上传 CSV 文件并确认内容，点击“开始发送”。</li>
          <li>注意控制发送频率，确保收件人均为有授权的用户，避免被判定为垃圾邮件。</li>
        </ol>
      </div>
    </div>
  </body>
  </html>
